{{extend 'layout.html'}}

<div id="target"></div>


<script id="template" type="text/ractive">

<div>
    {{if auth.user_id is None:}}
    <div id="main_login">
    {{=A('Sign Up', _class='btn btn-primary btn-lg', _href=URL('default', 'user', args=['register']))}}
    {{=A('Sign In', _class='btn btn-primary btn-lg', _href=URL('default', 'user', args=['login']))}}
    </div>
    {{else:}}
    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target=".bs-example-modal-lg">
     <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>&nbsp;Create a Menu
    </button>
    <div><a class="btn btn-success" id="btn_add" on-click="creatBoard">
    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
    Create Board</a>
    </div>
    {{pass}}
    {% #if loading %}
    <div id="load_spinner">
    <i class="fa fa-spinner fa-pulse fa-2x"></i>
    </div>
    {% /if %}
</div>
<br><br>

<!-- Modal -->
<div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Create a Menu</h4>

      </div>
      <div class="modal-body">
        <form id="menuForm">
        <div class="col-xs-6">
            <div class="form-group">
              <label class="sr-only" for="MenuName">Menu Name(required)</label>
              <div class="input-group ">
                <div class="input-group-addon">Your Menu Name:</div>
                <input type="text" class="form-control" id="menuName" placeholder="Menu Name" required>
              </div>
            </div>
          </div>



          <div id="list1">
          <div class="col-xs-10">
            <div class="form-group">
              <label class="sr-only" for="item1">item1</label>
              <div class="input-group ">
                <div class="input-group-addon">1</div>
                <input type="text" class="form-control" placeholder="Item Name">
              </div>
            </div>
          </div>
          <div class="col-xs-2">
            <div class="form-group">
             <label class="sr-only" for="price1">price1</label>
             <div class="input-group ">
                 <div class="input-group-addon">$</div>
                 <input type="number" class="form-control" placeholder="Price">
             </div>
            </div>
          </div>
        </div>

         <div id="list2">
          <div class="col-xs-10">
            <div class="form-group">
              <label class="sr-only" for="item2">item2</label>
              <div class="input-group ">
                <div class="input-group-addon">1</div>
                <input type="text" class="form-control" placeholder="Item Name">
              </div>
            </div>
          </div>
          <div class="col-xs-2">
            <div class="form-group">
             <label class="sr-only" for="price2">price2</label>
             <div class="input-group ">
                 <div class="input-group-addon">$</div>
                 <input type="number" class="form-control" placeholder="Price">
             </div>
            </div>
          </div>
        </div>

         <div id="list1">
          <div class="col-xs-10">
            <div class="form-group">
              <label class="sr-only" for="item3">item3</label>
              <div class="input-group ">
                <div class="input-group-addon">1</div>
                <input type="text" class="form-control" placeholder="Item Name">
              </div>
            </div>
          </div>
          <div class="col-xs-2">
            <div class="form-group">
             <label class="sr-only" for="price3">price3</label>
             <div class="input-group ">
                 <div class="input-group-addon">$</div>
                 <input type="number" class="form-control" placeholder="Price">
             </div>
            </div>
          </div>
        </div>

        </form>





      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" on-click="saveMenu">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-3 col-md-2 sidebar">
      <ul class="nav nav-sidebar">
        <li class="active"><a href="#">Overview <span class="sr-only">(current)</span></a></li>
        <li><a href="#">Reports</a></li>
        <li><a href="#">Analytics</a></li>
        <li><a href="#">Export</a></li>
      </ul>
      <ul class="nav nav-sidebar">
        <li><a href="">Nav item</a></li>
        <li><a href="">Nav item again</a></li>
        <li><a href="">One more nav</a></li>
        <li><a href="">Another nav item</a></li>
        <li><a href="">More navigation</a></li>
      </ul>
      <ul class="nav nav-sidebar">
        <li><a href="">Nav item again</a></li>
        <li><a href="">One more nav</a></li>
        <li><a href="">Another nav item</a></li>
      </ul>
    </div>



    <div class="col-sm-9">
      <h1 class="page-header">Dashboard</h1>
      <div class="board_list">
        {% #groupList:id %}
        <a class="link" href="{{=URL('default', 'groupOrders')}}/{% groupId %}">
        <div on-click="startedit" data-id="{% groupId %}" class="message col-md-3 board title"><p id="paragraph{% groupId %}">{% groupName %}</p>
        </div>
        </a>
        {% /groupList %}
      </div>
    </div>
  </div>
</div>










</script>





<script>
$(function() {
    var ractive = new Ractive({
        el: '#target',
        template: '#template',
        delimiters: ['{%', '%}'],
        tripleDelimiters: ['{%%', '%%}'],
        data: {
            board_list: {},
            loading: true,
            editing: false,

            groupList: {},
        }
    });

    $.ajax("{{=URL('default', 'load_messages', user_signature=True)}}",
        {
            method: 'POST',
            success: function (data) {
              ractive.set('board_list', data['board_list']);
              ractive.set('loading', false);
            }
        }
    );

    $.ajax("{{=URL('default', 'loadGroup', user_signature=True)}}",
        {
            method: 'POST',
            success: function (data) {
              ractive.set('groupList', data['groupList']);
              ractive.set('loading', false);
            }
        }
    );

    ractive.on("saveMenu", function() {
//        var t = $("input").eq(5).val();
//do validation price should be number,  input1 and input2 have to be filled both.
        var menuList = [];
        $("input").each(function(index, value) {
            if ($(this).val() != "") {
            menuList.push($(this).val());
            alert(menuList[index]);
            } else {
                menuList.push("null");
//                alert("null");
            }
        });

        $.ajax("{{=URL('default', 'addMenuList', user_signature=True)}}",
        {
          data: {
                menuList: menuList,
          },
          method: 'POST',
          success: function() {
            var board_list = ractive.get('board_list');
            if ( Board_id in board_list) {
              board_list[Board_id]['Board_Title'] = Board_Title;
            } else {
                board_list[board_list] = {
                Board_Title: Board_Title,
                Board_id: Board_id}
            }
            ractive.set('board_list', board_list);
          },
          error: function() {}
        }
    );






    });

$("#menuForm").validate();


    ractive.on("createGroup", function() {
        var groupName = $("#inputName").val();
        $("#inputName").val('');
        if (groupName != '') {
//            alert(groupName)
            $('#myModal').modal('hide')
            $.ajax("{{=URL('default', 'createGroup', user_signature=True)}}",
            {
              data: {
                groupName: groupName,
              },
              method: 'POST',
              success: function(data) {
                  ractive.set('groupList', data['groupList']);
                  ractive.set('loading', false);
              },
              error: function() {}
            });
        }
    });




    ractive.on("startedit", function(e) {
        ractive.set("editing", true);
        var id = $(e.node).data("id");
        $("#myText"+id).focus();
    });

    ractive.on("editdone", function (e){
       ractive.set("editing", false);
        var id = $(e.node).data("id");
        var text = $("#paragraph"+id).text();
        if (text === "") {
            text = "Board title can't be blank, please write some content";
        }
        send_message(text, id);
    });

    ractive.on("creatBoard", function (e) {
        var title = "write some content";
        send_title(title);
    });

    function send_title(Board_Title) {
        $.ajax("{{=URL('default', 'new_board', user_signature=True)}}",
        {
          data: {
            Board_Title: Board_Title,
          },
          method: 'POST',
          success: function(data) {
              ractive.set('board_list', data['board_list']);
              ractive.set('loading', false);
          },
          error: function() {}
        });
    }


  function send_message(Board_Title, Board_id) {
    $.ajax("{{=URL('default', 'add_msg', user_signature=True)}}",
        {
          data: {
            Board_Title: Board_Title,
            Board_id: Board_id
          },
          method: 'POST',
          success: function() {
            var board_list = ractive.get('board_list');
            if ( Board_id in board_list) {
              board_list[Board_id]['Board_Title'] = Board_Title;
            } else {
                board_list[board_list] = {
                Board_Title: Board_Title,
                Board_id: Board_id}
            }
            ractive.set('board_list', board_list);
          },
          error: function() {}
        }
    );
  }
});
</script>




